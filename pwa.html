<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventaire - Chef Pilot</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    header{background:#c41610;color:#fff;padding:14px 18px;font-weight:700;text-align:center}
    .wrap{max-width:980px;margin:18px auto;padding:0 12px}
    .card{background:#fff;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:16px}
    .topline{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
    .emp{font-weight:700}
    .status{font-size:14px;opacity:.8}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{border:1px solid #e6e6e6;padding:10px}
    th{background:#000;color:#fff;text-align:center}
    td:first-child{text-align:left}
    td:not(:first-child){text-align:center}
    input.qty{width:110px;padding:8px;border:1px solid #d0d0d0;border-radius:8px;text-align:center}
    .btn{appearance:none;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:#c41610;color:#fff}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}
    .footer{margin-top:14px;display:flex;gap:12px;justify-content:flex-end;align-items:center}
    .msg{font-size:14px}
  </style>
</head>
<body>
  <header>Inventaire - Chef Pilot</header>
  <div class="wrap">
    <div class="card">
      <div class="topline">
        <div class="emp">Emplacement : <span id="empName">–</span></div>
        <div class="status" id="status">Chargement…</div>
      </div>

      <div style="overflow-x:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th style="text-align:left">Produit</th>
              <th>Format</th>
              <th>Prix</th>
              <th>Quantité</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        <span class="msg" id="msg"></span>
        <button id="sendBtn" class="btn btn-primary">Envoyer les quantités</button>
      </div>
    </div>
  </div>

  <script>
  // === CONFIG: ton Apps Script /exec ===
  const APPS_SCRIPT_BASE = "https://script.google.com/macros/s/AKfycby-HKEw-pf8l3Bgnf_YJzTNNbSMwn5bbUNYGc_TJUKcpl_U73-COrPB9y8nBPRHGsP8HQ/exec";

  // Helpers
  const qs = (k)=> new URL(location.href).searchParams.get(k) || "";
  const fmtPrix = (v)=>{
    if(v===null||v===undefined||v==="") return "";
    const n=Number(v); return isFinite(n) ? "$"+n.toFixed(2) : String(v);
  };

  const token = qs("token");
  const emp   = qs("emp");
  const empEl = document.getElementById("empName");
  const tbody = document.getElementById("tbody");
  const statusEl = document.getElementById("status");
  const msgEl = document.getElementById("msg");
  const sendBtn = document.getElementById("sendBtn");

  empEl.textContent = emp || "–";

  if(!token || !emp){
    statusEl.textContent = "Lien incomplet (token/emp manquants).";
    sendBtn.disabled = true;
  }else{
    loadGrid().catch(err=>{
      console.error(err);
      statusEl.textContent = "Erreur de chargement.";
    });
  }

  // --- CHARGEMENT via action=items (avec cache-buster) ---
  async function loadGrid(){
    statusEl.textContent = "Chargement des produits…";
    const url = APPS_SCRIPT_BASE + "?action=items&token="+encodeURIComponent(token)+"&_="+Date.now();
    const r = await fetch(url, {method:"GET", headers:{ "Accept":"application/json" }});
    if(!r.ok){ throw new Error("HTTP "+r.status); }
    const data = await r.json();
    console.log("ITEMS RES =", data);

    if(!data || data.ok===false){
      statusEl.textContent = "Session invalide.";
      sendBtn.disabled = true;
      return;
    }
    // Normalisation + TRIM (empêche les espaces parasites type 'Amélanche ')
    const items = (data.items || []).map(x => ({
      Produit: (x.Produit ?? x.name ?? "").trim(),
      Format:  (x.Format  ?? x.unit ?? "").trim(),
      Prix:    x.Prix ?? x.price ?? ""
    }));

    renderRows(items);
    statusEl.textContent = items.length ? "Prêt à saisir" : "Aucun produit à afficher.";
  }

  function renderRows(items){
    tbody.innerHTML = "";
    for(const it of items){
      const tr = document.createElement("tr");

      const tdProd = document.createElement("td");
      tdProd.textContent = it.Produit || "";
      tr.appendChild(tdProd);

      const tdFmt = document.createElement("td");
      tdFmt.textContent = it.Format || "";
      tr.appendChild(tdFmt);

      const tdPrix = document.createElement("td");
      tdPrix.textContent = fmtPrix(it.Prix);
      tr.appendChild(tdPrix);

      const tdQty = document.createElement("td");
      const inp = document.createElement("input");
      inp.type = "number";
      inp.step = "0.001";
      inp.min = "0";
      inp.className = "qty";
      inp.placeholder = "0";
      inp.dataset.produit = (it.Produit || "").trim(); // TRIM ici aussi
      tdQty.appendChild(inp);
      tr.appendChild(tdQty);

      tbody.appendChild(tr);
    }
  }

  // --- ENVOI des quantités ---
  sendBtn.addEventListener("click", async ()=>{
    try{
      msgEl.textContent = "";
      sendBtn.disabled = true;
      statusEl.textContent = "Envoi en cours…";

      const entries = [];
      document.querySelectorAll("input.qty").forEach(inp=>{
        const raw = (inp.value||"").trim();
        if(!raw) return;
        const q = raw.replace(",", ".");
        const n = Number(q);
        if(!isFinite(n) || n < 0) return;
        entries.push({ Produit: (inp.dataset.produit || "").trim(), Quantite: String(n) });
      });

      const payload = { token, emp, entries };
      const r = await fetch(APPS_SCRIPT_BASE+"?action=submit", {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      });
      if(!r.ok){ throw new Error("HTTP "+r.status); }
      const data = await r.json();
      if(data && data.ok){
        statusEl.textContent = "Quantités envoyées ✅";
        msgEl.textContent = "Vous pouvez fermer cette page.";
      }else{
        throw new Error(data && data.error || "Réponse invalide");
      }
    }catch(err){
      console.error(err);
      statusEl.textContent = "Échec d’envoi.";
      msgEl.textContent = String(err);
      sendBtn.disabled = false;
    }
  });
  </script>
</body>
</html>

